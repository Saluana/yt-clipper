# requirements.md — YouTube Clip Maker

## Introduction

A web service that clips segments from YouTube videos (or uploaded files) between a start and end timestamp, with optional autogenerated subtitles. Prioritize performance, scalability, and reliability. The service exposes a REST API and uses **Bun + Elysia** for the API layer, **FFmpeg** for clipping, **Groq Whisper API** for ASR (subtitles), **Supabase** (**Postgres + Storage**) for metadata and file storage, and **Redis or Postgres-based queueing** (e.g., `pgmq`/`pg-boss`) for job distribution.

---

## Functional Requirements

### 1. Job Creation

-   **Endpoint**: `POST /api/jobs`
-   Accepts: sourceType (`youtube`|`upload`), youtubeUrl or uploadToken, start, end, withSubtitles, burnSubtitles, subtitleLang.
-   Validate timestamps, enforce max clip length.
-   Return jobId, status=queued, expiresAt.

### 2. File Uploads

-   **Endpoint**: `POST /api/uploads` or multipart `POST /api/jobs/upload`
-   Provide a **Supabase Storage** upload URL (signed) or accept file directly and upload server-side using the **service role key**.
-   Associate uploaded file with jobId and store under bucket `sources/{jobId}/source.ext`.

### 3. Job Processing

-   Use FFmpeg to trim video segment.
-   Prefer stream copy for speed, fallback to re-encode if needed.
-   If `withSubtitles=true`, call **Groq Whisper** (e.g., `whisper-large-v3` or `faster-whisper` variants) to produce `.srt` for just the `[start,end]` segment; optionally burn-in via FFmpeg.
-   Persist outputs to **Supabase Storage** under `results/{jobId}/clip.mp4` and optional `clip.srt`.

### 4. Job Status

-   **Endpoint**: `GET /api/jobs/:id`
-   Return status (`queued|processing|done|failed`), progress %, result URLs (or null), expiresAt, error (if any).

### 5. Result Delivery

-   **Endpoint**: `GET /api/jobs/:id/result`
-   Return **Supabase Storage signed URLs** for MP4 and optional SRT.

### 6. Error Handling

-   All errors follow `{ error: { code, message, details? } }` format.
-   Validation errors return HTTP 400; unauthorized YouTube downloads return 403.

### 7. Expiration & Cleanup

-   Results expire after `RETENTION_HOURS`.
-   Background worker deletes expired files and DB records; **Supabase Storage** objects are removed by key.

### 8. Performance & Scaling

-   Local NVMe scratch for temp files.
-   **Queue**: Redis Streams **or** Postgres-based queue (Supabase Postgres with `pgmq`/`pg-boss`).
-   **ASR**: Groq Whisper for low-latency GPU inference; fallback to local `whisper.cpp` if configured.
-   Horizontal scaling of API and workers.

### 9. Security

-   Signed **Supabase Storage** result URLs with short TTL.
-   Rate limits per IP.
-   ADMIN_ENABLED env flag to gate management routes.
-   Protect **Supabase service role key** and **GROQ_API_KEY**; server-side only.

### 10. Observability

-   Metrics: job duration, FFmpeg processing time, ASR processing time (Groq), queue lag.
-   Logs: structured JSON correlated by jobId; redact URLs and tokens.
-   Alerts: queue backlog, Groq error rate/latency spikes, high failure rate.

---

## Non-Functional Requirements

-   P95 for 30s clip without subtitles ≤ 30s; with subtitles ≤ 90s (via Groq Whisper).
-   Handle at least 100 concurrent stream-copy jobs per node.
-   Idempotent job processing to handle retries.
-   Compliant with YouTube ToS for content handling.

---

## API Endpoints Summary

-   `POST /api/jobs` — create new job.
-   `POST /api/uploads` — get upload URL.
-   `POST /api/jobs/upload` — upload file with job creation.
-   `GET /api/jobs/:id` — check job status.
-   `GET /api/jobs/:id/result` — get result URLs.
-   `GET /healthz` — health check.
-   `GET /metrics` — Prometheus metrics (admin only).

---

## Dependencies

-   Bun + Elysia (API)
-   Supabase (Postgres + Storage)
-   Redis **or** Postgres-based queue (`pgmq`, `pg-boss`)
-   FFmpeg (clipping)
-   **Groq Whisper API** (ASR)

---

## Acceptance Criteria

-   Valid requests are queued and processed within SLOs.
-   Invalid input returns clear, consistent error messages.
-   Progress is visible via `GET /api/jobs/:id`.
-   Subtitles are generated via **Groq Whisper** when requested; `.srt` delivered or burn-in applied.
-   Results are accessible via **Supabase signed URLs** until `expiresAt`.
-   Service scales horizontally without downtime.

---

## Risks & Mitigation

-   **YouTube ToS violations** — default to upload path; gate yt-dlp usage.
-   **Groq API outages or rate limits** — fallback to local whisper.cpp or queued retry with exponential backoff; surface 503 gracefully.
-   **High load** — queue backpressure; rate limiting; increase worker pool.
-   **Supabase throttling/limits** — tune multipart uploads; cache-bust and respect RLS; monitor usage quotas.

---

## Future Enhancements

-   WebSocket updates for real-time progress.
-   Multiple clip segments per job.
-   OAuth via Supabase Auth for user-specific job management.

---

## Configuration

-   `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`
-   `SUPABASE_STORAGE_BUCKET` (e.g., `clips`)
-   `GROQ_API_KEY`
-   `RETENTION_HOURS`, `MAX_CLIP_SECONDS`
-   Queue: `REDIS_URL` **or** Postgres DSN + queue schema
